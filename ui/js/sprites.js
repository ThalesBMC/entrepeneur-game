/**
 * Procedural pixel art sprite generator.
 * Each sprite is defined as a grid of palette indices, rendered 4x to an offscreen canvas,
 * then loaded as a PIXI.Texture.
 */

const SCALE = 4;

const PALETTE = {
  _: null,        // transparent
  0: "#0f0e17",   // black bg
  1: "#e2b714",   // gold / player
  2: "#c0392b",   // red / chest
  3: "#2ecc71",   // green / build
  4: "#e67e22",   // orange / ship
  5: "#3498db",   // blue / reach
  6: "#8e44ad",   // purple / epic
  7: "#ecf0f1",   // white / highlight
  8: "#5d4037",   // brown / wood
  9: "#1a5276",   // dark blue / water
  a: "#7f8c8d",   // gray / stone
  b: "#f39c12",   // bright gold
  c: "#27ae60",   // bright green
  d: "#2c3e50",   // dark
  e: "#d35400",   // dark orange
  f: "#fadbd8",   // skin
};

function renderSprite(grid, w, h) {
  const canvas = document.createElement("canvas");
  canvas.width = w * SCALE;
  canvas.height = h * SCALE;
  const ctx = canvas.getContext("2d");

  for (let y = 0; y < h; y++) {
    const row = grid[y];
    for (let x = 0; x < w; x++) {
      const ch = row[x];
      if (ch === "_" || ch === " ") continue;
      const color = PALETTE[ch];
      if (!color) continue;
      ctx.fillStyle = color;
      ctx.fillRect(x * SCALE, y * SCALE, SCALE, SCALE);
    }
  }
  return canvas;
}

function canvasToTexture(canvas) {
  return PIXI.Texture.from(canvas, { scaleMode: PIXI.SCALE_MODES.NEAREST });
}

// ── Hero Idle Frames (16x16) ──
const HERO_IDLE = [
  [ // frame 0
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "____11__11______",
    "____11__11______",
    "___880__088_____",
  ],
  [ // frame 1 (breathe up)
    "________________",
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "____11__11______",
    "____11__11______",
    "___880__088_____",
  ],
  [ // frame 2 (same as 0)
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "____11__11______",
    "____11__11______",
    "___880__088_____",
  ],
  [ // frame 3 (breathe down)
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "____11__11______",
    "___811__118_____",
    "___880__088_____",
  ],
];

// ── Hero Walk Frames (16x16) ──
const HERO_WALK = [
  [
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "____11__11______",
    "___11____11_____",
    "__880____088____",
  ],
  [
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "___11___11______",
    "___88___88______",
    "___88___88______",
  ],
  [
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "____11__11______",
    "_____11_11______",
    "____088_880_____",
  ],
  [
    "____111111______",
    "___1111111b_____",
    "___1bb11bb1_____",
    "___1f1ff1f1_____",
    "___1ff00ff1_____",
    "___1ffff0f1_____",
    "____1ffff1______",
    "____111111______",
    "_____1111_______",
    "___11111111_____",
    "__1111111111____",
    "__1111111111____",
    "___11111111_____",
    "___11___11______",
    "___88___88______",
    "___88___88______",
  ],
];

// ── Chest Closed (16x16) ──
const CHEST_CLOSED = [
  "________________",
  "________________",
  "___8888888888___",
  "__82222222222e__",
  "__82222222222e__",
  "__88888888888e__",
  "__82222122222e__",
  "__82222122222e__",
  "__82222b22222e__",
  "__82222b22222e__",
  "__82222222222e__",
  "__82222222222e__",
  "__8eeeeeeeeeee__",
  "________________",
  "________________",
  "________________",
];

// ── Chest Open Frames (16x16) ──
const CHEST_OPEN = [
  [ // frame 0: lid starting to open
    "___cccccccccc___",
    "___c3333333c____",
    "___cccccccccc___",
    "__82222222222e__",
    "__82222122222e__",
    "__82222b22222e__",
    "__82222b22222e__",
    "__82222222222e__",
    "__82222222222e__",
    "__8eeeeeeeeeee__",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
  ],
  [ // frame 1: lid open wide
    "__cccccccccccc__",
    "__c3333333333c__",
    "__c3333333333c__",
    "__cccccccccccc__",
    "__82222222222e__",
    "__827b7b7b722e__",
    "__82222222222e__",
    "__82222222222e__",
    "__8eeeeeeeeeee__",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
  ],
  [ // frame 2: lid fully open, glowing
    "__cccccccccccc__",
    "__c3333333333c__",
    "__c3b3b3b3b33c__",
    "__c3333333333c__",
    "__cccccccccccc__",
    "__8bb1b1b1bb2e__",
    "__8b1b1b1b1b2e__",
    "__82222222222e__",
    "__8eeeeeeeeeee__",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
    "________________",
  ],
];

// ── Island Sprites (48x48) — stone edges, terrain texture ──
function makeIslandGrid(accent) {
  const a = accent;
  return [
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "_________________aaaaaaaaaaaaaa__________________",
    "_______________aaaaaaaaaaaaaaaaaa________________",
    "_____________aaa"+a+a+a+a+a+a+a+a+a+a+a+a+"aaaa______________",
    "____________aa"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"aa_____________",
    "___________a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"aa____________",
    "__________a"+a+a+a+a+a+a+"a"+a+a+a+a+a+a+a+a+a+a+a+a+"aa___________",
    "_________a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a__________",
    "________a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a_________",
    "________a"+a+a+a+a+a+a+a+a+"a"+a+a+a+a+a+a+a+a+a+a+a+a+a+"a_________",
    "_______a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a________",
    "_______a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a________",
    "_______a"+a+a+a+a+a+a+a+a+a+a+a+a+a+"a"+a+a+a+a+a+a+a+a+a+a+"a________",
    "________a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a_________",
    "________a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a_________",
    "_________a"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a__________",
    "__________aa"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"a___________",
    "___________aa"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"aa____________",
    "____________aaa"+a+a+a+a+a+a+a+a+a+a+a+a+a+a+"aa______________",
    "_____________aaaa888888888888aaaa________________",
    "______________aaa88888888888aaa__________________",
    "________________aaa888888aaa____________________",
    "_________________aaaaaaaaaa_____________________",
    "__________________99999999______________________",
    "___________________999999_______________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
    "________________________________________________",
  ];
}

// ── Loot Icons (8x8) ──
const LOOT_ICONS = {
  build_shard: [
    "__aaaa__",
    "_aa77a__",
    "_a777aa_",
    "_aa77aa_",
    "__a77a__",
    "__aaaa__",
    "___aa___",
    "________",
  ],
  ship_token: [
    "__4444__",
    "_44bb4__",
    "_4bbbb4_",
    "_44bb44_",
    "__4bb4__",
    "__4444__",
    "___44___",
    "________",
  ],
  reach_leaf: [
    "___33___",
    "__3c33__",
    "_3cc333_",
    "_3ccc33_",
    "__3cc3__",
    "___83___",
    "___88___",
    "________",
  ],
  common_gem: [
    "__5555__",
    "_577775_",
    "_577775_",
    "_555555_",
    "__5555__",
    "___55___",
    "________",
    "________",
  ],
  rare_badge: [
    "___bb___",
    "__b11b__",
    "_b1771b_",
    "_b1771b_",
    "__b11b__",
    "___bb___",
    "________",
    "________",
  ],
  epic_badge: [
    "___66___",
    "__6776__",
    "_677776_",
    "_677776_",
    "__6776__",
    "___66___",
    "________",
    "________",
  ],
};

// ── Tree Variants (20x20) — taller canopies, thicker trunks ──
const TREES = [
  [
    "________33__________",
    "_______3333_________",
    "______333333________",
    "_____33333333_______",
    "____3c333c3333______",
    "____333333333c______",
    "_____33333333_______",
    "______333333________",
    "_______3333_________",
    "________88__________",
    "________88__________",
    "________88__________",
    "________88__________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
  ],
  [
    "_______3333_________",
    "______333333________",
    "_____33c33c33_______",
    "____3333333c33______",
    "____33333333c3______",
    "___333333333333_____",
    "____33c33333c3______",
    "_____33333333_______",
    "______333333________",
    "_______3333_________",
    "________88__________",
    "________88__________",
    "________88__________",
    "________88__________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
  ],
  [
    "________cc__________",
    "_______cccc_________",
    "______cc3ccc________",
    "_____cc333ccc_______",
    "____cccc3ccccc______",
    "____ccc3cccccc______",
    "_____cccccccc_______",
    "______cccccc________",
    "_______cccc_________",
    "________88__________",
    "________88__________",
    "________88__________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
    "____________________",
  ],
];

// ── Cat Walk Frames (16x16) — visible ears, tail, whisker dots ──
const CAT_WALK = [
  [
    "________________",
    "___aa____aa_____",
    "__aaaa__aaaa____",
    "__aaaaaaaaaa____",
    "__a0aa00aa0a____",
    "__aaaaaaaaaa7___",
    "___aaaaaaaa_____",
    "____aaaaaa______",
    "____aa__aa______",
    "____a____a______",
    "________________",
    "_______aaa______",
    "________aa______",
    "________________",
    "________________",
    "________________",
  ],
  [
    "________________",
    "___aa____aa_____",
    "__aaaa__aaaa____",
    "__aaaaaaaaaa____",
    "__a0aa00aa0a____",
    "__aaaaaaaaaa7___",
    "___aaaaaaaa_____",
    "____aaaaaa______",
    "____aa__aa______",
    "_____a__a_______",
    "________________",
    "______aaa_______",
    "_______aa_______",
    "________________",
    "________________",
    "________________",
  ],
  [
    "________________",
    "___aa____aa_____",
    "__aaaa__aaaa____",
    "__aaaaaaaaaa____",
    "__a0aa00aa0a____",
    "__aaaaaaaaaa7___",
    "___aaaaaaaa_____",
    "____aaaaaa______",
    "____aa__aa______",
    "___a______a_____",
    "________________",
    "_____aaa________",
    "______aa________",
    "________________",
    "________________",
    "________________",
  ],
  [
    "________________",
    "___aa____aa_____",
    "__aaaa__aaaa____",
    "__aaaaaaaaaa____",
    "__a0aa00aa0a____",
    "__aaaaaaaaaa7___",
    "___aaaaaaaa_____",
    "____aaaaaa______",
    "____aa__aa______",
    "_____a__a_______",
    "________________",
    "______aaa_______",
    "_______aa_______",
    "________________",
    "________________",
    "________________",
  ],
];

// ── Cloud (24x8) ──
const CLOUD = [
  "________77777777________",
  "______777777777777______",
  "____7777777777777777____",
  "___77777777777777777____",
  "__77777777777777777777__",
  "___77777777777777777____",
  "_____77777777777777_____",
  "________77777777________",
];

// ── Texture cache ──
const textureCache = {};

function getTextures(name, grids, w, h) {
  if (textureCache[name]) return textureCache[name];
  const textures = grids.map((g) => canvasToTexture(renderSprite(g, w, h)));
  textureCache[name] = textures;
  return textures;
}

function getTexture(name, grid, w, h) {
  if (textureCache[name]) return textureCache[name];
  const t = canvasToTexture(renderSprite(grid, w, h));
  textureCache[name] = t;
  return t;
}

export function heroIdleTextures() { return getTextures("hero_idle", HERO_IDLE, 16, 16); }
export function heroWalkTextures() { return getTextures("hero_walk", HERO_WALK, 16, 16); }
export function chestClosedTexture() { return getTexture("chest_closed", CHEST_CLOSED, 16, 16); }
export function chestOpenTextures() { return getTextures("chest_open", CHEST_OPEN, 16, 16); }

export function islandTexture(cat) {
  const accent = { build: "3", ship: "4", reach: "5" }[cat] || "3";
  return getTexture("island_" + cat, makeIslandGrid(accent), 48, 48);
}

export function lootTexture(name) {
  const grid = LOOT_ICONS[name];
  if (!grid) return null;
  return getTexture("loot_" + name, grid, 8, 8);
}

export function treeTexture(variant) {
  return getTexture("tree_" + variant, TREES[variant % TREES.length], 20, 20);
}

export function catWalkTextures() { return getTextures("cat_walk", CAT_WALK, 16, 16); }
export function cloudTexture() { return getTexture("cloud", CLOUD, 24, 8); }

// ── Enemy Sprites (12x12) ──
const ENEMY_PROCRASTINATION = [
  "____________",
  "___222222___",
  "__22222222__",
  "__2207720e__",
  "__2277772e__",
  "__2222222e__",
  "__2200002e__",
  "__22222222__",
  "___222222___",
  "____2222____",
  "___22__22___",
  "____________",
];

const ENEMY_DISTRACTION = [
  "____________",
  "___666666___",
  "__66666666__",
  "__6607760e__",
  "__6677776e__",
  "__6666666e__",
  "__6600006e__",
  "__66666666__",
  "___666666___",
  "____6666____",
  "___66__66___",
  "____________",
];

const ENEMY_LAZY = [
  "____________",
  "___cccccc___",
  "__cccccccc__",
  "__cc07cc0e__",
  "__ccccccce__",
  "__ccccccce__",
  "__cc0000ce__",
  "__cccccccc__",
  "___cccccc___",
  "____cccc____",
  "___cc__cc___",
  "____________",
];

const ENEMY_SOCIAL = [
  "____________",
  "___555555___",
  "__55555555__",
  "__5507750e__",
  "__5577775e__",
  "__5555555e__",
  "__5500005e__",
  "__55555555__",
  "___555555___",
  "____5555____",
  "___55__55___",
  "____________",
];

const ENEMIES = [ENEMY_PROCRASTINATION, ENEMY_DISTRACTION, ENEMY_LAZY, ENEMY_SOCIAL];

export function enemyTexture(type) {
  return getTexture("enemy_" + type, ENEMIES[type % ENEMIES.length], 12, 12);
}

// ── Activity Props (12x12) ──
const PROP_COMPUTER = [
  "____________",
  "__aaaaaaaa__",
  "__a5555a5a__",
  "__a5555a5a__",
  "__a5555555__",
  "__aaaaaaaa__",
  "____aaaa____",
  "___aaaaaa___",
  "____________",
  "____________",
  "____________",
  "____________",
];

const PROP_CRATE = [
  "____________",
  "__44444444__",
  "__4e4444e4__",
  "__44e44e44__",
  "__444ee444__",
  "__44e44e44__",
  "__4e4444e4__",
  "__44444444__",
  "____________",
  "____________",
  "____________",
  "____________",
];

const PROP_TARGET = [
  "____________",
  "____2222____",
  "___277772___",
  "__27711772__",
  "__27711772__",
  "__27711772__",
  "___277772___",
  "____2222____",
  "____________",
  "____________",
  "____________",
  "____________",
];

const ACTIVITY_PROPS = { build: PROP_COMPUTER, ship: PROP_CRATE, reach: PROP_TARGET };

export function activityPropTexture(cat) {
  const grid = ACTIVITY_PROPS[cat];
  if (!grid) return null;
  return getTexture("prop_" + cat, grid, 12, 12);
}

// ── Police NPC Sprites (16x16) — blue uniform, dark hat ──
const POLICE_IDLE = [
  [ // frame 0
    "____999999______",
    "___9999999d_____",
    "___99999999_____",
    "___9f9ff9f9_____",
    "___9ff00ff9_____",
    "___9ffff0f9_____",
    "____9ffff9______",
    "____555555______",
    "_____5555_______",
    "___55555555_____",
    "__5555555555____",
    "__5555555555____",
    "___55555555_____",
    "____55__55______",
    "____55__55______",
    "___000__000_____",
  ],
  [ // frame 1 (breathe)
    "________________",
    "____999999______",
    "___9999999d_____",
    "___99999999_____",
    "___9f9ff9f9_____",
    "___9ff00ff9_____",
    "___9ffff0f9_____",
    "____9ffff9______",
    "____555555______",
    "___55555555_____",
    "__5555555555____",
    "__5555555555____",
    "___55555555_____",
    "____55__55______",
    "____55__55______",
    "___000__000_____",
  ],
];

const POLICE_WALK = [
  [
    "____999999______",
    "___9999999d_____",
    "___99999999_____",
    "___9f9ff9f9_____",
    "___9ff00ff9_____",
    "___9ffff0f9_____",
    "____9ffff9______",
    "____555555______",
    "_____5555_______",
    "___55555555_____",
    "__5555555555____",
    "__5555555555____",
    "___55555555_____",
    "____55__55______",
    "___55____55_____",
    "__000____000____",
  ],
  [
    "____999999______",
    "___9999999d_____",
    "___99999999_____",
    "___9f9ff9f9_____",
    "___9ff00ff9_____",
    "___9ffff0f9_____",
    "____9ffff9______",
    "____555555______",
    "_____5555_______",
    "___55555555_____",
    "__5555555555____",
    "__5555555555____",
    "___55555555_____",
    "___55___55______",
    "___00___00______",
    "___00___00______",
  ],
  [
    "____999999______",
    "___9999999d_____",
    "___99999999_____",
    "___9f9ff9f9_____",
    "___9ff00ff9_____",
    "___9ffff0f9_____",
    "____9ffff9______",
    "____555555______",
    "_____5555_______",
    "___55555555_____",
    "__5555555555____",
    "__5555555555____",
    "___55555555_____",
    "____55__55______",
    "_____55_55______",
    "____000_000_____",
  ],
  [
    "____999999______",
    "___9999999d_____",
    "___99999999_____",
    "___9f9ff9f9_____",
    "___9ff00ff9_____",
    "___9ffff0f9_____",
    "____9ffff9______",
    "____555555______",
    "_____5555_______",
    "___55555555_____",
    "__5555555555____",
    "__5555555555____",
    "___55555555_____",
    "___55___55______",
    "___00___00______",
    "___00___00______",
  ],
];

export function policeIdleTextures() { return getTextures("police_idle", POLICE_IDLE, 16, 16); }
export function policeWalkTextures() { return getTextures("police_walk", POLICE_WALK, 16, 16); }

export function playerShadowTexture() {
  if (textureCache["player_shadow"]) return textureCache["player_shadow"];
  const w = 20, h = 8;
  const canvas = document.createElement("canvas");
  canvas.width = w * SCALE;
  canvas.height = h * SCALE;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.beginPath();
  ctx.ellipse(w * SCALE / 2, h * SCALE / 2, w * SCALE / 2, h * SCALE / 2, 0, 0, Math.PI * 2);
  ctx.fill();
  const t = PIXI.Texture.from(canvas, { scaleMode: PIXI.SCALE_MODES.NEAREST });
  textureCache["player_shadow"] = t;
  return t;
}
